if /bin/sh ${ATOMICDIR}/chkdup.sh arch_${atomic}_try_cmpxchg${order} try_cmpxchg
then
cat <<EOF
/**
 * arch_${atomic}_try_cmpxchg${order} - Atomic cmpxchg with bool return value
 * @v:  pointer of type ${atomic}_t
 * @old:  desired old value to match
 * @new:  new value to put in
 *
 * Atomically compares @new to *@v, and if equal, stores @new to *@v,
 * providing ${docbook_order} ordering.
 * Returns @true if the cmpxchg operation succeeded, and @false otherwise.
 * On failure, stores the original value of *@v into *@old, which permits
 * a retry without a reload from *@v.
 */
EOF
fi
cat <<EOF
static __always_inline bool
arch_${atomic}_try_cmpxchg${order}(${atomic}_t *v, ${int} *old, ${int} new)
{
	${int} r, o = *old;
	r = arch_${atomic}_cmpxchg${order}(v, o, new);
	if (unlikely(r != o))
		*old = r;
	return likely(r == o);
}
EOF
